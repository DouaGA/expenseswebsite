{% load static %}
{% block title %}Tableau de bord Agent - GreenMap{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    /* Layout Styles */
    .main-container {
        display: flex;
        min-height: 100vh;
    }
    
    /* Sidebar Styles */
.sidebar {
    width: 250px;
    height: 100vh;
    background: #1e5631; /* Nouvelle couleur verte foncée */
    color: #ecf0f1;
    position: fixed;
    left: 0;
    top: 0;
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    z-index: 1000;
}

.sidebar-header {
    padding: 20px;
    text-align: center;
    background-color: #1a4d2a; /* Un vert légèrement plus foncé pour le header */
}

.sidebar-header .logo {
    margin: 0;
    font-size: 1.5rem;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
}

.sidebar-header .logo i {
    margin-right: 10px;
    color: #4ccb7e; /* Vert plus clair pour l'icône */
}

.sidebar-header .subtitle {
    margin: 5px 0 0;
    font-size: 0.8rem;
    color: #bdc3c7;
}

.sidebar-nav {
    flex: 1;
    padding: 20px 0;
    overflow-y: auto;
}

.sidebar-nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.sidebar-nav li {
    margin-bottom: 5px;
}

.sidebar-nav a {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    color: #ecf0f1;
    text-decoration: none;
    transition: all 0.3s;
    font-size: 0.95rem;
}

.sidebar-nav a:hover {
    background: rgba(255,255,255,0.1);
    padding-left: 25px;
}

.sidebar-nav a.active {
    background: rgba(76, 203, 126, 0.2); /* Vert plus clair pour l'élément actif */
    border-left: 4px solid #4ccb7e;
    color: #fff;
}

.sidebar-nav i {
    width: 24px;
    text-align: center;
    margin-right: 12px;
    font-size: 1.1rem;
}

.sidebar-nav .logout-item a {
    color: #ff6b6b; /* Rouge plus doux */
}

.sidebar-nav .logout-item a:hover {
    background: rgba(255, 107, 107, 0.1);
}

.sidebar-footer {
    padding: 15px 20px;
    border-top: 1px solid rgba(255,255,255,0.1);
    background-color: #1a4d2a; /* Même couleur que le header */
}

.user-info {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
}

.user-info i {
    margin-right: 10px;
    font-size: 1.2rem;
    color: #4ccb7e; /* Vert clair pour l'icône utilisateur */
}

/* Main content adjustment */
.main-content {
    margin-left: 250px;
    padding: 20px;
    width: calc(100% - 250px);
}

    /* Dashboard Styles */
    .stat-card {
        border-radius: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border: none;
        overflow: hidden;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 10px rgba(0,0,0,0.15);
    }
    
    .stat-card .card-body {
        padding: 1.5rem;
    }
    
    .stat-card h6 {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .stat-card h2 {
        font-weight: 700;
        margin-bottom: 0;
        font-size: 2rem;
    }
    
    .stat-card .icon-wrapper {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(255,255,255,0.2);
    }

    .chart-container {
        height: 280px;
        min-height: 280px;
        position: relative;
    }
    
    .claim-item {
        border-left: 4px solid transparent;
        transition: all 0.3s;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }
    
    .claim-item:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
    }
    
    .pending-item {
        border-left-color: #ffc107;
        background-color: rgba(255, 193, 7, 0.05);
    }
    
    .accepted-item {
        border-left-color: #28a745;
        background-color: rgba(40, 167, 69, 0.05);
    }
    
    .rejected-item {
        border-left-color: #dc3545;
        background-color: rgba(220, 53, 69, 0.05);
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        padding: 1rem 1.5rem;
        border-radius: 10px 10px 0 0 !important;
    }
    
    .btn-action {
        width: 10px;
        height: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        border-radius: 50%;
        transition: all 0.2s;
    }
    
    .btn-action:hover {
        transform: scale(1.1);
    }

    /* Colors */
    .bg-pending {
        background-color: #ffc107 !important;
    }
    
    .bg-accepted {
        background-color: #28a745 !important;
    }
    
    .bg-rejected {
        background-color: #dc3545 !important;
    }
    
    .text-pending {
        color: #ffc107 !important;
    }
    
    .text-accepted {
        color: #28a745 !important;
    }
    
    .text-rejected {
        color: #dc3545 !important;
    }

    /* Mobile Toggle Button */
    #sidebarToggle {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1050;
        display: none;
        background-color: #1e5631;
        border: none;
    }
    
    /* Responsive adjustments */
    @media (max-width: 992px) {
        #sidebarToggle {
            display: block;
        }
        
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        .main-content {
            margin-left: 0;
            width: 100%;
        }
        
        /* Adjust cards for mobile */
        .claims-row {
            flex-direction: column;
        }
        
        .claims-row > div {
            width: 100%;
            margin-bottom: 20px;
        }
    }

    /* No Data Placeholder */
    .no-data-placeholder {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #6c757d;
        z-index: 1;
    }

    .no-data-placeholder i {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: block;
        color: #adb5bd;
    }
    
    /* Grid layout for claims cards */
    .claims-row {
        display: flex;
        flex-wrap: wrap;
        margin-right: -15px;
        margin-left: -15px;
    }
    
    .claims-row > div {
        flex: 0 0 33.333333%;
        max-width: 33.333333%;
        padding-right: 15px;
        padding-left: 15px;
    }
    
    @media (max-width: 1200px) {
        .claims-row > div {
            flex: 0 0 50%;
            max-width: 50%;
        }
    }
    
    @media (max-width: 768px) {
        .claims-row > div {
            flex: 0 0 100%;
            max-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-sticky">
            <div class="sidebar-header">
                <h4 class="logo">
                    <i class="fas fa-leaf me-2"></i>CityCare
                </h4>
            </div>
            
            <div class="sidebar-nav">
                <ul>
                    <li>
                        <a class="active" href="{% url 'agent_dashboard' %}">
                            <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'claims_list' %}">
                            <i class="fas fa-list me-2"></i> Réclamations
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'claims_map' %}">
                            <i class="fas fa-map-marked-alt me-2"></i> Carte interactive
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'stats' %}">
                            <i class="fas fa-chart-bar me-2"></i> Statistiques
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'profile' %}">
                            <i class="fas fa-user me-2"></i> Profil
                        </a>
                    </li>
                    <li class="logout-item">
                        <form action="{% url 'logout' %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-link text-danger p-0" style="background:none;border:none;">
                                <i class="fas fa-sign-out-alt me-2"></i> Déconnexion
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span>{{ request.user.username }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Mobile Toggle Button -->
        <button class="btn btn-sm" id="sidebarToggle">
            <i class="fas fa-bars text-white"></i>
        </button>

        <!-- Dashboard Content -->
        <div class="container-fluid">
            <h2 class="mb-4">Tableau de bord</h2>
            
            <!-- Status Cards -->
            <div class="row mb-4">
                <div class="col-xl-4 col-md-6 mb-4">
                    <div class="card stat-card bg-pending text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6><i class="fas fa-clock me-1"></i> EN ATTENTE</h6>
                                    <h2 class="mb-0">{{ total_pending }}</h2>
                                    <small class="opacity-75">{{ pending_percentage }}% du total</small>
                                </div>
                                <div class="icon-wrapper">
                                    <i class="fas fa-hourglass-half fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-4 col-md-6 mb-4">
                    <div class="card stat-card bg-accepted text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6><i class="fas fa-check-circle me-1"></i> ACCEPTÉES</h6>
                                    <h2 class="mb-0">{{ total_accepted }}</h2>
                                    <small class="opacity-75">{{ accepted_percentage }}% du total</small>
                                </div>
                                <div class="icon-wrapper">
                                    <i class="fas fa-thumbs-up fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-4 col-md-6 mb-4">
                    <div class="card stat-card bg-rejected text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6><i class="fas fa-times-circle me-1"></i> REJETÉES</h6>
                                    <h2 class="mb-0">{{ total_rejected }}</h2>
                                    <small class="opacity-75">{{ rejected_percentage }}% du total</small>
                                </div>
                                <div class="icon-wrapper">
                                    <i class="fas fa-thumbs-down fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="row mb-4">
                <!-- Type Chart (Radar) -->
                <div class="col-lg-4 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-radar me-2"></i>RÉPARTITION PAR TYPE</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container radar-chart-container">
                                <canvas id="typeChart"></canvas>
                                {% if not has_data %}
                                <div class="no-data-placeholder">
                                    <i class="fas fa-chart-pie"></i>
                                    <p>Aucune donnée disponible</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Evolution Chart (Line) -->
                <div class="col-lg-4 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>ÉVOLUTION (30 JOURS)</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="evolutionChart"></canvas>
                                {% if not has_data %}
                                <div class="no-data-placeholder">
                                    <i class="fas fa-chart-line"></i>
                                    <p>Aucune donnée disponible</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Chart (Doughnut) -->
                <div class="col-lg-4 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>RÉPARTITION PAR STATUT</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                                {% if not has_data %}
                                <div class="no-data-placeholder">
                                    <i class="fas fa-chart-pie"></i>
                                    <p>Aucune donnée disponible</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Claims Lists Row 2 -->
            <div class="row claims-row">
                <!-- Pending Claims -->
                <div class="col-lg-4 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-pending text-white">
                            <h5 class="mb-0"><i class="fas fa-clock me-2"></i>DERNIÈRES EN ATTENTE</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                {% for claim in pending_claims %}
                                <div class="list-group-item claim-item pending-item">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0 font-weight-bold">{{ claim.title|truncatechars:30 }}</h6>
                                        <small class="text-muted">{{ claim.created_at|date:"d/m/Y" }}</small>
                                    </div>
                                    <p class="mb-2 text-muted small">{{ claim.description|truncatechars:60 }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-pending">
                                            <i class="fas fa-clock"></i> En attente depuis {{ claim.created_at|timesince }}
                                        </small>
                                        <div>
                                            <button class="btn btn-success btn-action me-1" title="Accepter" onclick="updateClaimStatus({{ claim.id }}, 'accepted')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-danger btn-action" title="Rejeter" onclick="updateClaimStatus({{ claim.id }}, 'rejected')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="list-group-item text-center py-4">
                                    <i class="fas fa-check-circle fa-2x text-muted mb-2"></i>
                                    <p class="mb-0 text-muted">Aucune réclamation en attente</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Accepted Claims -->
                <div class="col-lg-4 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-accepted text-white">
                            <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>DERNIÈRES ACCEPTÉES</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                {% for claim in accepted_claims %}
                                <div class="list-group-item claim-item accepted-item">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0 font-weight-bold">{{ claim.title|truncatechars:30 }}</h6>
                                        <small class="text-muted">{{ claim.created_at|date:"d/m/Y" }}</small>
                                    </div>
                                    <p class="mb-2 text-muted small">{{ claim.description|truncatechars:60 }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-accepted">
                                            <i class="fas fa-check-circle"></i> Acceptée le {{ claim.updated_at|date:"d/m/Y" }}
                                        </small>
                                        <a href="{% url 'core:agent_claim_detail' claim.id %}" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="list-group-item text-center py-4">
                                    <i class="fas fa-check-circle fa-2x text-muted mb-2"></i>
                                    <p class="mb-0 text-muted">Aucune réclamation acceptée</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Rejected Claims -->
                <div class="col-lg-4 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-rejected text-white">
                            <h5 class="mb-0"><i class="fas fa-times-circle me-2"></i>DERNIÈRES REJETÉES</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                {% for claim in rejected_claims %}
                                <div class="list-group-item claim-item rejected-item">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0 font-weight-bold">{{ claim.title|truncatechars:30 }}</h6>
                                        <small class="text-muted">{{ claim.created_at|date:"d/m/Y" }}</small>
                                    </div>
                                    <p class="mb-2 text-muted small">{{ claim.description|truncatechars:60 }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-rejected">
                                            <i class="fas fa-times-circle"></i> Rejetée le {{ claim.updated_at|date:"d/m/Y" }}
                                        </small>
                                        <a href="{% url 'core:agent_claim_detail' claim.id %}" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="list-group-item text-center py-4">
                                    <i class="fas fa-times-circle fa-2x text-muted mb-2"></i>
                                    <p class="mb-0 text-muted">Aucune réclamation rejetée</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
// Sidebar Toggle for Mobile
// Sidebar Toggle for Mobile
document.getElementById('sidebarToggle').addEventListener('click', function() {
    document.querySelector('.sidebar').classList.toggle('active');
});

// Charts Initialization
document.addEventListener('DOMContentLoaded', function() {
    const hasData = {{ has_data|yesno:"true,false" }};
    if (!hasData) return;

    const chartColors = {
        pending: '#ffc107',
        accepted: '#28a745',
        rejected: '#dc3545',
        others: ['#17a2b8', '#6c757d', '#343a40', '#6610f2', '#fd7e14']
    };

    function hidePlaceholder(canvasId) {
        const placeholder = document.querySelector(`#${canvasId}`).parentNode.querySelector('.no-data-placeholder');
        if (placeholder) placeholder.style.display = 'none';
    }

    // Type Chart (Radar)
    const typeCtx = document.getElementById('typeChart');
    if (typeCtx && {{ type_data|safe }}.some(item => item > 0)) {
        hidePlaceholder('typeChart');
        new Chart(typeCtx, {
            type: 'radar',
            data: {
                labels: {{ type_labels|safe }},
                datasets: [{
                    label: 'Nombre de réclamations',
                    data: {{ type_data|safe }},
                    backgroundColor: 'rgba(0, 123, 255, 0.2)',
                    borderColor: '#007bff',
                    borderWidth: 2,
                    pointBackgroundColor: '#007bff',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { r: {
                    angleLines: { display: true, color: 'rgba(0, 0, 0, 0.1)' },
                    suggestedMin: 0,
                    ticks: {
                        backdropColor: 'rgba(255, 255, 255, 0.8)',
                        color: '#6c757d',
                        font: { size: 10 },
                        stepSize: 1
                    },
                    pointLabels: { font: { size: 11 }, color: '#495057' },
                    grid: { color: 'rgba(0, 0, 0, 0.1)' }
                }},
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw} réclamation(s)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Status Chart (Doughnut)
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx && {{ status_data|safe }}.some(item => item > 0)) {
        hidePlaceholder('statusChart');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: {{ status_labels|safe }},
                datasets: [{
                    data: {{ status_data|safe }},
                    backgroundColor: [chartColors.pending, chartColors.accepted, chartColors.rejected],
                    borderWidth: 1,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((context.raw / total) * 100);
                                return `${context.label}: ${context.raw} (${percentage}%)`;
                            }
                        }
                    },
                    datalabels: {
                        formatter: (value, ctx) => {
                            const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return percentage > 5 ? `${percentage}%` : '';
                        },
                        color: '#fff',
                        font: { weight: 'bold' }
                    }
                },
                cutout: '70%',
                animation: { animateScale: true, animateRotate: true }
            },
            plugins: [ChartDataLabels]
        });
    }

    // Evolution Chart (Line)
    const evolutionCtx = document.getElementById('evolutionChart');
    if (evolutionCtx && {{ daily_counts|safe }}.some(item => item > 0)) {
        hidePlaceholder('evolutionChart');
        new Chart(evolutionCtx, {
            type: 'line',
            data: {
                labels: {{ dates|safe }},
                datasets: [{
                    label: 'Réclamations',
                    data: {{ daily_counts|safe }},
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderColor: chartColors.accepted,
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: chartColors.accepted,
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { drawBorder: false, color: 'rgba(0, 0, 0, 0.05)' },
                        ticks: { color: '#6c757d', precision: 0 },
                        title: {
                            display: true,
                            text: 'Nombre de réclamations',
                            color: '#6c757d'
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#6c757d' },
                        title: { display: true, text: 'Date', color: '#6c757d' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.raw}`;
                            }
                        }
                    }
                }
            }
        });
    }
});

// Update Claim Status
function updateClaimStatus(claimId, status) {
    if (!confirm(`Voulez-vous vraiment ${status === 'accepted' ? 'accepter' : 'rejeter'} cette réclamation ?`)) return;
    
    fetch(`{% url 'update_claim_status' 0 'status' %}`.replace('0', claimId).replace('status', status), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.ok ? response.json() : response.json().then(err => { throw new Error(err.message || 'Erreur serveur') }))
    .then(data => data.success ? window.location.reload() : alert(data.message || "Erreur lors de la mise à jour"))
    .catch(error => {
        console.error('Error:', error);
        alert("Erreur : " + error.message);
    });
}
</script>
{% endblock %}