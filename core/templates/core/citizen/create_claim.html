{% extends 'core/base_auth.html' %}
{% load crispy_forms_tags %}
{% load leaflet_tags %}

{% block title %}Nouvelle Réclamation{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
    /* Styles pour la carte */
    #map {
        height: 400px !important;
        width: 100%;
        margin: 15px 0;
        border-radius: 8px;
        border: 1px solid #ddd;
        background: #f8f9fa;
        z-index: 1;
    }
    
    .leaflet-container {
        height: 100% !important;
        min-height: 400px;
    }
    
    .location-btn {
        margin-bottom: 15px;
    }
    
    .form-section {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .custom-marker {
        background-color: #4361ee;
        border-radius: 50%;
        border: 3px solid white;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 12px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .leaflet-top {
        z-index: 1000;
    }
    
    .leaflet-control {
        z-index: 1000;
    }
    
    .existing-claim-marker {
        background-color: #f72585;
        border-radius: 50%;
        border: 3px solid white;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    #map-fallback {
        display: none;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-plus-circle me-2"></i>Nouvelle Réclamation
        </h1>
        <a href="{% url 'core:citizen_dashboard' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Retour
        </a>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="form-section">
                <form method="POST" enctype="multipart/form-data" id="claim-form">
                    {% csrf_token %}
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            {{ form.title|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            {{ form.claim_type|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="id_municipality" class="form-label">Municipalité*</label>
                            <select name="municipality" class="form-select" id="id_municipality" required>
                              <option value="">--- CHOISIR ---</option>
                              {% for mun in municipalities %}
                              <option value="{{ mun.id }}">{{ mun.name }}</option>
                              {% empty %}
                              <option value="">Aucune municipalité trouvée</option>
                              {% endfor %}
                            </select>
                          </div>
                        </div>
                        <div class="col-md-6">
                            {{ form.attachment|as_crispy_field }}
                        </div>
                    </div>
                    
                    {{ form.description|as_crispy_field }}
                    
                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="fas fa-map-marker-alt me-2"></i>Localisation
                        </h5>
                        <div id="map-container" style="position:relative;">
                            {% leaflet_map "map" callback="window.map_init" %}
                            <div id="map-fallback">
                                <p class="text-danger">Le chargement de la carte a échoué. Veuillez recharger la page.</p>
                                <button onclick="window.location.reload()" class="btn btn-sm btn-warning">
                                    <i class="fas fa-sync-alt me-1"></i> Recharger
                                </button>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <button type="button" id="locate-btn" class="btn btn-outline-primary">
                                <i class="fas fa-location-arrow me-1"></i> Utiliser ma position actuelle
                            </button>
                            <small class="text-muted">Ou cliquez sur la carte pour sélectionner un emplacement</small>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                {{ form.location_lat|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.location_lng|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end mt-4">
                        <button type="reset" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-eraser me-1"></i> Effacer
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-1"></i> Soumettre la réclamation
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Fonction d'initialisation de la carte
    window.map_init = function(map, options) {
        console.log("Initialisation de la carte en cours...");
        
        // Initialiser la vue de la carte
        map.setView([36.7525, 3.042], 13);
        
        // Ajouter la couche OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Forcer le redimensionnement de la carte
        setTimeout(() => {
            map.invalidateSize();
            console.log("Redimensionnement de la carte effectué");
        }, 100);

        let marker = null;
        const latInput = document.getElementById('id_location_lat');
        const lngInput = document.getElementById('id_location_lng');

        // Données des réclamations existantes
        const existingClaims = JSON.parse('{{ existing_claims_json|escapejs }}');

        // Ajout des marqueurs existants
        existingClaims.forEach(claim => {
            if (claim.location_lat && claim.location_lng) {
                const claimIcon = L.divIcon({
                    className: 'existing-claim-marker',
                    html: `<i class="fas fa-exclamation" style="font-size: 10px; color: white;"></i>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                const claimMarker = L.marker(
                    [parseFloat(claim.location_lat), parseFloat(claim.location_lng)],
                    {icon: claimIcon}
                ).addTo(map);
                
                claimMarker.bindPopup(`
                    <b>${claim.title || 'Sans titre'}</b><br>
                    Type: ${claim.claim_type || 'Non spécifié'}<br>
                    ${claim.description ? claim.description.substring(0, 50) + '...' : ''}
                `);
            }
        });

        // Gestion du clic sur la carte
        map.on('click', function(e) {
            updateMapMarker(e.latlng);
            updatePositionFields(e.latlng.lat, e.latlng.lng);
        });

        // Bouton de géolocalisation
        document.getElementById('locate-btn').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const userLatLng = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        updateMapMarker(userLatLng);
                        map.setView(userLatLng, 15);
                        updatePositionFields(userLatLng.lat, userLatLng.lng);
                    },
                    function(error) {
                        alert("Erreur de géolocalisation : " + error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                alert("La géolocalisation n'est pas supportée par votre navigateur.");
            }
        });

        // Mise à jour du marqueur
        function updateMapMarker(latlng) {
            if (marker) {
                map.removeLayer(marker);
            }
            
            marker = L.marker(latlng, {
                draggable: true,
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map);
            
            marker.on('dragend', function(event) {
                const position = marker.getLatLng();
                updatePositionFields(position.lat, position.lng);
            });
        }

        // Mise à jour des champs de position
        function updatePositionFields(lat, lng) {
            latInput.value = lat;
            lngInput.value = lng;
        }

        // Initialisation avec des valeurs existantes
        if (latInput.value && lngInput.value) {
            const existingLatLng = {
                lat: parseFloat(latInput.value),
                lng: parseFloat(lngInput.value)
            };
            updateMapMarker(existingLatLng);
            map.setView(existingLatLng, 15);
        }

        // Validation du formulaire
        document.getElementById('claim-form').addEventListener('submit', function(e) {
            if (!latInput.value || !lngInput.value) {
                e.preventDefault();
                alert('Veuillez sélectionner une localisation sur la carte');
                return false;
            }
            return true;
        });
    };

    // Vérification du chargement de la carte
    setTimeout(() => {
        if (!document.querySelector('.leaflet-layer')) {
            document.getElementById('map-fallback').style.display = 'block';
            console.error("Erreur: La carte Leaflet n'a pas pu charger");
        }
    }, 3000);

    // Debug
    console.log("Municipalités:", JSON.parse('{{ municipalities|escapejs }}'));
    console.log("Réclamations existantes:", JSON.parse('{{ existing_claims_json|escapejs }}'));
</script>
{% endblock %}