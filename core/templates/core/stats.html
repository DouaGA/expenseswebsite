{% load static %}

{% block title %}Performance de Traitement{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance de Traitement</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary-color: #4e73df;
            --success-color: #1cc88a;
            --danger-color: #e74a3b;
            --warning-color: #f6c23e;
        }
        
        body {
            background-color: #f8f9fc;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        .card {
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 0.5rem 2rem 0 rgba(58, 59, 69, 0.2);
        }
        
        .card-header {
            border-radius: 0.5rem 0.5rem 0 0 !important;
            font-weight: 600;
        }
        
        .table thead th {
            border-top: none;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--primary-color);
        }
        
        .table tbody tr {
            transition: all 0.2s ease;
        }
        
        .table tbody tr:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .badge {
            font-weight: 500;
            letter-spacing: 0.5px;
            min-width: 80px;
        }
        
        .btn-lg {
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-lg:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .modal-content {
            border-radius: 0.7rem;
            overflow: hidden;
            border: none;
        }
        
        #detailsContent img {
            max-height: 300px;
            object-fit: contain;
            border: 1px solid #eee;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .status-pending {
            background-color: rgba(246, 194, 62, 0.08);
        }
        
        .status-accepted {
            background-color: rgba(28, 200, 138, 0.08);
        }
        
        .status-rejected {
            background-color: rgba(231, 74, 59, 0.08);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: text-bottom;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }
        
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .card-body .row {
                flex-direction: column;
            }
            
            .col-md-4 {
                margin-top: 1.5rem;
            }
            
            .btn-lg {
                padding: 0.75rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
<div class="container-fluid px-0">
    <h1 class="h3 mb-4 text-gray-800">Performance de Traitement</h1>
    
    <!-- Section des nouvelles réclamations -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 bg-primary text-white">
            <h5 class="m-0 font-weight-bold">Nouvelle Réclamation à Traiter</h5>
        </div>
        <div class="card-body">
            {% if new_reclamation %}
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <h6 class="font-weight-bold text-primary">Informations de la réclamation</h6>
                        <div class="pl-3">
                            <p class="mb-1"><strong>ID:</strong> <span class="text-muted">{{ new_reclamation.id }}</span></p>
                            <p class="mb-1"><strong>Type:</strong> <span class="text-muted">{{ new_reclamation.claim_type.name|default:"Non spécifié" }}</span></p>
                            <p class="mb-1"><strong>Date:</strong> <span class="text-muted">{{ new_reclamation.created_at|date:"d/m/Y H:i" }}</span></p>
                            <p class="mb-1"><strong>Description:</strong> <span class="text-muted">{{ new_reclamation.description|default:"Aucune description" }}</span></p>
                            <p class="mb-1"><strong>Municipalité:</strong> <span class="text-muted">{{ new_reclamation.municipality.name|default:"Non spécifiée" }}</span></p>
                            <p class="mb-1"><strong>Créé par:</strong> <span class="text-muted">{{ new_reclamation.created_by.username }}</span></p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 d-flex align-items-center">
                    <div class="d-grid gap-3 w-100">
                        <form method="post" action="{% url 'update_claim_status' new_reclamation.id 'accepted' %}" class="mb-0">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success btn-lg py-3 shadow-sm">
                                <i class="fas fa-check-circle me-2"></i>Approuver
                            </button>
                        </form>
                        <form method="post" action="{% url 'update_claim_status' new_reclamation.id 'rejected' %}" class="mb-0">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-lg py-3 shadow-sm">
                                <i class="fas fa-times-circle me-2"></i>Rejeter
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-success d-flex align-items-center">
                <i class="fas fa-check-circle me-2 fa-lg"></i>
                <div>
                    <strong>Toutes les réclamations ont été traitées !</strong>
                    <div class="small">Aucune nouvelle réclamation en attente de traitement.</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
                    
    <!-- Section des statistiques et historique -->
    <div class="card shadow">
        <div class="card-header py-3 d-flex flex-column flex-md-row justify-content-between align-items-center">
            <h5 class="m-0 font-weight-bold text-primary">Historique des Réclamations</h5>
            <div class="mt-2 mt-md-0">
                <div class="input-group">
                    <select id="statusFilter" class="form-select form-select-sm border-primary">
                        <option value="all">Tous les statuts</option>
                        <option value="accepted">Acceptées</option>
                        <option value="rejected">Refusées</option>
                        <option value="pending">En attente</option>
                    </select>
                    <button id="filterBtn" class="btn btn-sm btn-primary" type="button">
                        <i class="fas fa-filter me-1"></i> Filtrer
                    </button>
                    <button id="resetFilterBtn" class="btn btn-sm btn-outline-secondary" type="button">
                        <i class="fas fa-undo me-1"></i> 
                        <span class="d-none d-md-inline">Réinitialiser</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if avg_processing_time %}
            <div class="alert alert-info mb-4 py-2">
                <i class="fas fa-clock me-2"></i>
                <strong>Temps moyen de traitement:</strong> {{ avg_processing_time }} heures
            </div>
            {% endif %}
            
            <div class="table-responsive">
                <table class="table table-sm table-hover table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th class="text-nowrap">ID</th>
                            <th class="text-nowrap">Type</th>
                            <th class="text-nowrap">Date</th>
                            <th class="text-nowrap">Municipalité</th>
                            <th class="text-nowrap">Statut</th>
                            <th class="text-nowrap">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reclamation in reclamations %}
                        <tr class="status-{{ reclamation.status }}">
                            <td>{{ reclamation.id }}</td>
                            <td>{{ reclamation.claim_type.name|default:"-" }}</td>
                            <td class="text-nowrap">{{ reclamation.created_at|date:"d/m/Y H:i" }}</td>
                            <td>{{ reclamation.municipality.name|default:"-" }}</td>
                            <td>
                                {% if reclamation.status == 'accepted' %}
                                    <span class="badge bg-success rounded-pill px-3 py-1">Acceptée</span>
                                {% elif reclamation.status == 'rejected' %}
                                    <span class="badge bg-danger rounded-pill px-3 py-1">Refusée</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark rounded-pill px-3 py-1">En attente</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary view-details" data-id="{{ reclamation.id }}">
                                    <i class="fas fa-eye me-1"></i> Détails
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">Aucune réclamation trouvée</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les détails -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Détails de la réclamation</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="detailsContent">
                <div class="text-center my-4 py-3">
                    <div class="loading-spinner"></div>
                    <p class="mt-2 text-muted">Chargement des détails...</p>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" id="closeModalButton">
                    <i class="fas fa-times me-1"></i> Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialisation du modal Bootstrap
    const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
    const detailsContent = document.getElementById('detailsContent');
    const closeModalButton = document.getElementById('closeModalButton');
    
    // Fonction pour formater la date
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        
        const date = new Date(dateString);
        if (isNaN(date)) return dateString;
        
        return date.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    // Fonction pour afficher les détails de la réclamation
    async function showClaimDetails(id) {
        // Afficher le loader
        detailsContent.innerHTML = `
            <div class="text-center my-4 py-3">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted">Chargement des détails...</p>
            </div>
        `;
        
        detailsModal.show();
        
        // Endpoints API à essayer
        const apiEndpoints = [
            `/api/claims/${id}/`,
            `/claims/api/claims/${id}/`,
            `/api/reclamations/${id}/`,
            `/api/claim/${id}/detail/`
        ];
        
        // Fonction pour afficher une erreur
        function showError(message) {
            detailsContent.innerHTML = `
                <div class="alert alert-danger">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
                        <div>
                            <h5 class="alert-heading">Erreur</h5>
                            <p class="mb-2">${message}</p>
                            <button class="btn btn-sm btn-primary" onclick="window.location.reload()">
                                <i class="fas fa-sync-alt me-1"></i> Réessayer
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-3 px-3">
                    <p class="mb-1">Vous pouvez aussi essayer de :</p>
                    <ul class="small">
                        <li>Vérifier votre connexion internet</li>
                        <li>Rafraîchir la page (F5)</li>
                        <li>Contacter l'administrateur si le problème persiste</li>
                    </ul>
                </div>
            `;
        }
        
        // Essayer chaque endpoint
        for (let i = 0; i < apiEndpoints.length; i++) {
            try {
                const response = await fetch(apiEndpoints[i]);
                
                if (!response.ok) continue;
                
                const data = await response.json();
                const claimData = Array.isArray(data) ? data[0] : data;
                
                if (!claimData || claimData.error) continue;
                
                // Afficher les détails
                detailsContent.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="font-weight-bold text-primary mb-3">Informations de base</h6>
                                <p class="mb-2"><strong>ID:</strong> <span class="text-muted">${claimData.id || 'N/A'}</span></p>
                                <p class="mb-2"><strong>Type:</strong> <span class="text-muted">${claimData.claim_type?.name || claimData.type || 'Non spécifié'}</span></p>
                                <p class="mb-2"><strong>Date:</strong> <span class="text-muted">${formatDate(claimData.created_at || claimData.date)}</span></p>
                                <p class="mb-2"><strong>Statut:</strong> <span class="text-muted text-capitalize">${claimData.status || 'Inconnu'}</span></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="font-weight-bold text-primary mb-3">Localisation</h6>
                                <p class="mb-2"><strong>Créé par:</strong> <span class="text-muted">${claimData.created_by?.username || claimData.user || 'Non spécifié'}</span></p>
                                <p class="mb-2"><strong>Municipalité:</strong> <span class="text-muted">${claimData.municipality?.name || claimData.location || 'Non spécifiée'}</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6 class="font-weight-bold text-primary mb-3">Description</h6>
                        <div class="bg-light p-3 rounded">
                            <p class="mb-0">${claimData.description || 'Aucune description disponible'}</p>
                        </div>
                    </div>
                    ${claimData.image_url ? `
                    <div class="mt-4">
                        <h6 class="font-weight-bold text-primary mb-3">Image</h6>
                        <div class="text-center">
                            <img src="${claimData.image_url}" class="img-fluid rounded shadow-sm" alt="Image de la réclamation" style="max-height: 300px;">
                        </div>
                    </div>` : ''}
                `;
                
                return; // Sortir si la requête a réussi
            } catch (error) {
                console.error(`Erreur avec l'endpoint ${apiEndpoints[i]}:`, error);
                if (i === apiEndpoints.length - 1) {
                    showError("Impossible de charger les détails (API non disponible)");
                }
            }
        }
    }
    
    // Gestion du clic sur les boutons de détails
    document.querySelectorAll('.view-details').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            showClaimDetails(id);
        });
    });
    
    // Gestion du bouton Fermer
    closeModalButton.addEventListener('click', function() {
        detailsModal.hide();
    });
    
    // Gestion du filtrage
    const statusFilter = document.getElementById('statusFilter');
    const filterBtn = document.getElementById('filterBtn');
    const resetFilterBtn = document.getElementById('resetFilterBtn');
    const tableRows = document.querySelectorAll('tbody tr');
    
    // Appliquer le filtre
    function applyFilter(status) {
        tableRows.forEach(row => {
            const rowStatus = row.className.match(/status-(\w+)/)?.[1] || '';
            if (status === 'all' || rowStatus === status) {
                row.style.display = '';
                row.classList.add('animate__animated', 'animate__fadeIn');
            } else {
                row.style.display = 'none';
                row.classList.remove('animate__animated', 'animate__fadeIn');
            }
        });
        
        // Mettre à jour l'URL sans recharger la page
        const url = new URL(window.location);
        if (status === 'all') {
            url.searchParams.delete('status');
        } else {
            url.searchParams.set('status', status);
        }
        window.history.pushState({}, '', url);
    }
    
    // Écouteurs d'événements
    filterBtn.addEventListener('click', () => applyFilter(statusFilter.value));
    
    resetFilterBtn.addEventListener('click', () => {
        statusFilter.value = 'all';
        applyFilter('all');
    });
    
    // Appliquer le filtre au chargement si paramètre dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const statusParam = urlParams.get('status');
    if (statusParam && ['accepted', 'rejected', 'pending'].includes(statusParam)) {
        statusFilter.value = statusParam;
        applyFilter(statusParam);
    }
    
    // Animation au chargement
    setTimeout(() => {
        document.querySelectorAll('tbody tr').forEach((row, index) => {
            row.style.opacity = 0;
            setTimeout(() => {
                row.style.transition = 'opacity 0.3s ease';
                row.style.opacity = 1;
            }, index * 50);
        });
    }, 100);
});
</script>
</body>
</html>
{% endblock %}