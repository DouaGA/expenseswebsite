{% extends 'base.html' %}

{% block title %}Carte Interactive des Réclamations{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
<style>
    /* [Vos styles CSS existants conservés] */
    
    /* Ajout pour le panel de détails */
    .details-panel {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100vh;
        background: white;
        box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        transition: right 0.3s ease;
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
    }
    
    .details-panel.active { right: 0; }
    
    .detail-item { margin-bottom: 15px; }
    .detail-label { font-weight: bold; color: var(--dark-color); }
    .detail-value { 
        padding: 8px; 
        background: #f8f9fa; 
        border-radius: 6px;
        word-break: break-word;
    }
    
    .close-details {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 1.5rem;
        cursor: pointer;
    }
    
    .images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }
    
    .claim-image {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 6px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- [Votre en-tête existant] -->
    
    <!-- [Vos filtres existants] -->

    <div id="map"></div>
    
    <!-- Panel des détails -->
    <div id="details-panel" class="details-panel">
        <span class="close-details">&times;</span>
        <div id="details-content"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // [Votre initialisation de carte existante]
    
    const detailsPanel = document.getElementById('details-panel');
    const closeBtn = document.querySelector('.close-details');
    
    // Fermeture du panel
    closeBtn.addEventListener('click', function() {
        detailsPanel.classList.remove('active');
    });

    // [Vos fonctions createCustomIcon et addLegend existantes]

    // Charger les signalements avec filtres
    function loadClaims() {
        // [Votre code de filtrage existant]
        
        fetch(url)
        .then(response => response.json())
        .then(data => {
            // [Votre traitement des marqueurs existant]
            
            data.forEach(claim => {
                // [Votre création de marqueur existante]
                
                const popupContent = `
                    <div class="info-window">
                        <h5>${claim.title || 'Signalement sans titre'}</h5>
                        <!-- [Vos autres infos] -->
                        <div class="action-buttons">
                            <button onclick="showClaimDetails(${claim.id})" class="btn btn-info">
                                <i class="fas fa-eye mr-1"></i> Voir détails
                            </button>
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                markers[claim.id] = marker;
            });
        });
    }

    // Afficher les détails complets
    window.showClaimDetails = function(claimId) {
        fetch(`/admin/claims/claim/${claimId}/change/?_popup=1`)
            .then(response => response.text())
            .then(html => {
                // Extraire les données de la page admin
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Récupérer les données du formulaire admin
                const form = doc.querySelector('#claim_form');
                if (!form) throw new Error('Formulaire admin non trouvé');
                
                const claimData = {
                    title: form.querySelector('[name="title"]')?.value,
                    claim_type: form.querySelector('[name="claim_type"] option:checked')?.text,
                    status: form.querySelector('[name="status"] option:checked')?.text,
                    description: form.querySelector('[name="description"]')?.value,
                    location_address: form.querySelector('[name="location_address"]')?.value,
                    admin_comment: form.querySelector('[name="admin_comment"]')?.value,
                    created_at: form.querySelector('[name="created_at"]')?.value,
                    images: Array.from(form.querySelectorAll('.field-image img')).map(img => img.src)
                };
                
                // Afficher dans le panel
                displayClaimDetails(claimData);
            })
            .catch(error => {
                console.error('Erreur:', error);
                // Fallback vers l'API si l'accès admin échoue
                fetch(`/api/claims/${claimId}/`)
                    .then(response => response.json())
                    .then(displayClaimDetails)
                    .catch(err => {
                        alert('Erreur de chargement des détails');
                    });
            });
    };
    
    function displayClaimDetails(claim) {
        const detailsContent = document.getElementById('details-content');
        const createdAt = claim.created_at ? new Date(claim.created_at) : new Date();
        
        detailsContent.innerHTML = `
            <h4>${claim.title || 'Signalement sans titre'}</h4>
            
            <div class="detail-item">
                <div class="detail-label">Type</div>
                <div class="detail-value">${claim.claim_type || 'Non spécifié'}</div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label">Statut</div>
                <div class="detail-value">${claim.status || 'Non spécifié'}</div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label">Date</div>
                <div class="detail-value">${createdAt.toLocaleDateString('fr-FR')}</div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label">Localisation</div>
                <div class="detail-value">${claim.location_address || 'Non spécifié'}</div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label">Description</div>
                <div class="detail-value">${claim.description || 'Aucune description'}</div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label">Commentaire admin</div>
                <div class="detail-value">${claim.admin_comment || 'Aucun commentaire'}</div>
            </div>
            
            ${claim.images && claim.images.length > 0 ? `
            <div class="detail-item">
                <div class="detail-label">Images</div>
                <div class="images-grid">
                    ${claim.images.map(img => `<img src="${img}" class="claim-image">`).join('')}
                </div>
            </div>
            ` : ''}
            
            <div class="mt-3">
                <a href="/admin/claims/claim/${claim.id}/change/" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Modifier dans l'admin
                </a>
            </div>
        `;
        
        detailsPanel.classList.add('active');
    }

    // [Vos autres fonctions existantes]
    
    // Chargement initial
    loadClaims();
    addLegend();
});
</script>
{% endblock %}